<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Control de Horarios - Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700;900&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --success: #00C853;
            --success-dark: #00A040;
            --danger: #FF3D00;
            --warning: #FFA000;
            --bg-main: #0A0E27;
            --bg-card: #151937;
            --bg-card-hover: #1a1f45;
            --text-primary: #FFFFFF;
            --text-secondary: #8B92B8;
            --border: #252B54;
            --accent-cyan: #00E5FF;
            --accent-purple: #B388FF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            color: var(--text-primary) !important;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
            -webkit-user-select: none;
            transition: filter 0.3s;
        }

        /* Enhanced screenshot blocking */
        body:active {
            filter: blur(10px);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 102, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(179, 136, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1.5rem;
            padding: 3rem;
            max-width: 450px;
            width: 100%;
            text-align: center;
            animation: fadeIn 0.6s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .login-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .input-field {
            width: 100%;
            padding: 1rem;
            background: var(--bg-main);
            border: 2px solid var(--border);
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-family: 'JetBrains Mono', monospace;
            letter-spacing: 0.2rem;
            text-align: center;
            transition: all 0.3s ease;
            margin: 1.5rem 0;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-cyan), var(--primary));
            border: none;
            border-radius: 0.75rem;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 229, 255, 0.4);
        }

        .error-message {
            background: rgba(255, 61, 0, 0.1);
            border: 1px solid var(--danger);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
        }

        /* Logout Button */
        .logout-btn {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--danger);
            border: none;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(255, 61, 0, 0.3);
        }

        .logout-btn:hover {
            background: #D63000;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 61, 0, 0.5);
        }

        /* Welcome Banner */
        .welcome-banner {
            text-align: center;
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease;
        }

        .welcome-banner h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        /* Time Display */
        .time-display {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            animation: fadeIn 0.8s ease;
        }

        .current-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 3.5rem;
            font-weight: 600;
            color: var(--accent-cyan) !important;
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
        }

        .current-date {
            color: var(--text-secondary) !important;
            margin-top: 0.5rem;
            font-size: 1.2rem;
        }

        /* Employee Action Button */
        .employee-action {
            display: flex;
            justify-content: center;
            margin: 3rem 0;
        }

        .action-btn-large {
            background: var(--bg-card);
            border: 3px solid var(--border);
            border-radius: 2rem;
            padding: 3rem 5rem;
            cursor: pointer;
            transition: all 0.4s ease;
            font-size: 2rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .action-btn-large:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 60px rgba(0, 229, 255, 0.3);
        }

        .action-btn-large.entrada {
            border-color: var(--success);
            color: var(--success) !important;
        }

        .action-btn-large.salida {
            border-color: var(--danger);
            color: var(--danger) !important;
        }

        .btn-icon-large {
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
        }

        /* Admin Interface */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            animation: fadeInDown 0.6s ease;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--bg-card);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            border: 1px solid var(--border);
        }

        .role-indicator {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .role-master {
            background: linear-gradient(135deg, #FFD700, #FFA000);
            color: #000 !important;
        }

        .role-admin {
            background: linear-gradient(135deg, var(--accent-purple), var(--primary));
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: var(--text-secondary) !important;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: var(--text-primary) !important;
        }

        .tab.active {
            color: var(--accent-cyan) !important;
            border-bottom-color: var(--accent-cyan);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Employee Management */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .employee-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .employee-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .employee-card.blocked {
            opacity: 0.5;
            border-color: var(--danger);
        }

        .employee-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .employee-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            background: var(--bg-main);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-small.danger {
            border-color: var(--danger);
            color: var(--danger) !important;
        }

        .btn-small.warning {
            border-color: var(--warning);
            color: var(--warning) !important;
        }

        .btn-small.primary {
            border-color: var(--primary);
            color: var(--primary) !important;
        }

        .btn-add {
            background: linear-gradient(135deg, var(--success), var(--success-dark));
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        /* Filters */
        .filters-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-input {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        /* Table */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary) !important;
            text-transform: uppercase;
            font-size: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--bg-card-hover);
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-cyan) !important;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary) !important;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-secondary) !important;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-cyan);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .btn-cancel {
            padding: 0.75rem 1.5rem;
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .btn-submit {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--accent-cyan), var(--primary));
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-cyan) !important;
            margin: 0.5rem 0;
        }

        .stat-label {
            color: var(--text-secondary) !important;
            font-size: 0.9rem;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .current-time { font-size: 2.5rem; }
            .action-btn-large { padding: 2rem 3rem; font-size: 1.5rem; }
        }

        .supabase-config-notice {
            background: rgba(255, 160, 0, 0.1);
            border: 1px solid var(--warning);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .supabase-config-notice h3 {
            color: var(--warning) !important;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">üîê</div>
            <h1 class="login-title">Control de Horarios</h1>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Ingrese su contrase√±a</p>
            <input 
                type="password" 
                id="passwordInput" 
                class="input-field" 
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                maxlength="6"
                autocomplete="off"
            >
            <button type="button" class="login-btn" onclick="handleLoginClick()">Ingresar</button>
            <div id="loginError" class="error-message hidden"></div>
        </div>
    </div>

    <!-- Employee Interface -->
    <div id="employeeInterface" class="container hidden">
        <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        
        <div class="welcome-banner">
            <h2>üëã Hola, <span id="employeeName"></span>!</h2>
            <p style="color: var(--text-secondary);">Bienvenido al sistema de control de horarios</p>
        </div>

        <div class="time-display">
            <div class="current-time" id="employeeTime">--:--:--</div>
            <div class="current-date" id="employeeDate">-- de ----- de ----</div>
        </div>

        <div class="employee-action">
            <button class="action-btn-large entrada" id="employeeActionBtn" onclick="handleEmployeeAction()">
                <span class="btn-icon-large" id="actionIcon">üö™</span>
                <span id="actionText">ENTRADA</span>
            </button>
        </div>

        <div id="recordsPreview" class="table-container hidden">
            <h3 style="margin-bottom: 1rem;">Mis Registros Recientes</h3>
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Horas Trabajadas</th>
                    </tr>
                </thead>
                <tbody id="employeeRecordsBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Admin/Master Interface -->
    <div id="adminInterface" class="container hidden">
        <button class="logout-btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        
        <div class="supabase-config-notice">
            <h3>‚ö†Ô∏è Configuraci√≥n Requerida</h3>
            <p>Para que funcione la conexi√≥n con Supabase, debes editar el archivo y agregar tus credenciales en la secci√≥n de JavaScript (busca "CONFIGURACI√ìN SUPABASE")</p>
        </div>

        <div class="admin-header">
            <div class="user-badge">
                <span id="roleIndicator" class="role-indicator"></span>
                <span id="userName"></span>
            </div>
        </div>

        <div class="time-display">
            <div class="current-time" id="adminTime">--:--:--</div>
            <div class="current-date" id="adminDate">-- de ----- de ----</div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('employees')">üë• Colaboradores</button>
            <button class="tab" onclick="switchTab('records')">üìã Historial</button>
            <button class="tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('activity')">üîç Actividad</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Configuraci√≥n</button>
        </div>

        <!-- Employees Tab -->
        <div id="employeesTab" class="tab-content active">
            <button class="btn-add" onclick="openAddEmployeeModal()">‚ûï Agregar Colaborador</button>
            <div class="employee-grid" id="employeesGrid"></div>
        </div>

        <!-- Records Tab -->
        <div id="recordsTab" class="tab-content">
            <!-- Filters Section -->
            <div class="filters-section">
                <input type="text" class="filter-input" id="filterEmployee" placeholder="Buscar por nombre..." onkeyup="applyFilters()">
                <input type="date" class="filter-input" id="filterDateStart" onchange="applyFilters()" placeholder="Desde">
                <input type="date" class="filter-input" id="filterDateEnd" onchange="applyFilters()" placeholder="Hasta">
                <button class="btn-small primary" onclick="clearFilters()">üîÑ Limpiar</button>
                <button class="btn-small primary" onclick="exportToExcel()">üìä Exportar Excel</button>
            </div>

            <div class="table-container">
                <h2 style="margin-bottom: 1.5rem;">Historial de Registros</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Colaborador</th>
                            <th>Entrada</th>
                            <th>Salida</th>
                            <th>Horas (hh:mm:ss)</th>
                            <th>Observaciones</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="recordsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content">
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <!-- Activity Log Tab -->
        <div id="activityTab" class="tab-content">
            <div class="table-container">
                <h2 style="margin-bottom: 1.5rem;">Registro de Actividad del Sistema</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th>
                            <th>Usuario</th>
                            <th>Acci√≥n</th>
                            <th>Detalles</th>
                        </tr>
                    </thead>
                    <tbody id="activityLogBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settingsTab" class="tab-content">
            <div class="table-container">
                <h2 style="margin-bottom: 1.5rem;">‚öôÔ∏è Configuraci√≥n</h2>
                <div style="max-width: 500px;">
                    <div class="form-group">
                        <label class="form-label">Cambiar Mi Contrase√±a</label>
                        <input type="password" id="newOwnPassword" class="form-input" placeholder="Nueva contrase√±a (6 d√≠gitos)" maxlength="6">
                        <button class="btn-submit" style="margin-top: 1rem;" onclick="changeOwnPassword()">Cambiar Contrase√±a</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agregar Colaborador</h2>
                <button class="close-btn" onclick="closeModal('addEmployeeModal')">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Nombre Completo</label>
                <input type="text" class="form-input" id="newEmployeeName">
            </div>
            <div class="form-group">
                <label class="form-label">Contrase√±a (6 d√≠gitos)</label>
                <input type="password" class="form-input" id="newEmployeePassword" maxlength="6">
            </div>
            <div class="form-actions">
                <button class="btn-cancel" onclick="closeModal('addEmployeeModal')">Cancelar</button>
                <button class="btn-submit" onclick="handleAddEmployee()">Agregar</button>
            </div>
        </div>
    </div>

    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Cambiar Contrase√±a</h2>
                <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            <input type="hidden" id="changePasswordUserId">
            <div class="form-group">
                <label class="form-label">Nueva Contrase√±a (6 d√≠gitos)</label>
                <input type="password" class="form-input" id="newPassword" maxlength="6">
            </div>
            <div class="form-actions">
                <button class="btn-cancel" onclick="closeModal('changePasswordModal')">Cancelar</button>
                <button class="btn-submit" onclick="handleChangePassword()">Cambiar</button>
            </div>
        </div>
    </div>

    <div id="addCommentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agregar Observaciones</h2>
                <button class="close-btn" onclick="closeModal('addCommentModal')">&times;</button>
            </div>
            <input type="hidden" id="commentRecordId">
            <div class="form-group">
                <label class="form-label">Observaciones</label>
                <textarea class="form-textarea" id="commentText" rows="4"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn-cancel" onclick="closeModal('addCommentModal')">Cancelar</button>
                <button class="btn-submit" onclick="handleAddComment()">Guardar</button>
            </div>
        </div>
    </div>

    <div id="editRecordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Editar Registro</h2>
                <button class="close-btn" onclick="closeModal('editRecordModal')">&times;</button>
            </div>
            <input type="hidden" id="editRecordId">
            <input type="hidden" id="editRecordType">
            <div class="form-group">
                <label class="form-label">Nueva Hora</label>
                <input type="time" step="1" class="form-input" id="editRecordTime">
            </div>
            <div class="form-group">
                <label class="form-label">Motivo de la Edici√≥n</label>
                <textarea class="form-textarea" id="editRecordReason" rows="3"></textarea>
            </div>
            <div class="form-actions">
                <button class="btn-cancel" onclick="closeModal('editRecordModal')">Cancelar</button>
                <button class="btn-submit" onclick="handleEditRecord()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE
        // ============================================
        // IMPORTANTE: Reemplaza con tus credenciales de Supabase
        const SUPABASE_URL = 'https://TU_PROYECTO.supabase.co';
        const SUPABASE_ANON_KEY = 'TU_ANON_KEY_AQUI';
        
        let supabase = null;
        let useSupabase = false;

        // Intentar inicializar Supabase
        try {
            if (SUPABASE_URL !== 'https://TU_PROYECTO.supabase.co' && typeof window.supabase !== 'undefined') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                useSupabase = true;
                console.log('‚úÖ Supabase conectado');
            } else {
                console.warn('‚ö†Ô∏è Usando almacenamiento local (Supabase no configurado)');
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Error al conectar Supabase, usando almacenamiento local:', error);
        }

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let systemPasswords = {
            master: localStorage.getItem('masterPassword') || '111111',
            admin: localStorage.getItem('adminPassword') || '222222'
        };

        let currentUser = null;
        let employees = [];
        let records = [];
        let activityLog = [];
        let inactivityTimer = null;
        let filteredRecords = [];

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        function init() {
            updateAllClocks();
            setInterval(updateAllClocks, 1000);
            setupPasswordFocus();
            preventScreenshot();
            loadData();
        }

        // Auto-focus password field
        function setupPasswordFocus() {
            setTimeout(() => {
                const passInput = document.getElementById('passwordInput');
                if (passInput) passInput.focus();
            }, 100);
        }

        // Enhanced Screenshot Prevention
        function preventScreenshot() {
            // Print Screen key
            document.addEventListener('keyup', (e) => {
                if (e.key === 'PrintScreen') {
                    navigator.clipboard.writeText('');
                    showToast('Captura de pantalla deshabilitada', 'error');
                }
            });

            // Ctrl/Cmd + Shift + S (screenshot shortcuts)
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'S' || e.key === 's')) {
                    e.preventDefault();
                    showToast('Captura de pantalla deshabilitada', 'error');
                }
            });

            // Blur on unfocus (makes screenshots less useful)
            let blurTimeout;
            window.addEventListener('blur', () => {
                if (currentUser?.role === 'employee') {
                    document.body.style.filter = 'blur(10px)';
                }
            });

            window.addEventListener('focus', () => {
                document.body.style.filter = 'none';
            });
        }

        // Update Clocks
        function updateAllClocks() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const dateStr = now.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const formattedDate = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);

            ['employeeTime', 'adminTime'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = timeStr;
            });

            ['employeeDate', 'adminDate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = formattedDate;
            });
        }

        // Inactivity Logout
        function resetInactivityTimer() {
            if (inactivityTimer) clearTimeout(inactivityTimer);
            if (currentUser) {
                inactivityTimer = setTimeout(() => {
                    logActivity('AUTO_LOGOUT', `Cierre de sesi√≥n autom√°tico por inactividad`, currentUser.name);
                    showToast('Sesi√≥n cerrada por inactividad', 'error');
                    logout();
                }, 60000);
            }
        }

        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);

        // ============================================
        // DATA MANAGEMENT (Supabase + Fallback)
        // ============================================
        async function loadData() {
            if (useSupabase) {
                try {
                    // Load employees
                    const { data: empData } = await supabase.from('employees').select('*');
                    employees = empData || [];

                    // Load records
                    const { data: recData } = await supabase.from('time_records').select('*');
                    records = recData || [];

                    // Load activity log
                    const { data: actData } = await supabase.from('activity_log').select('*');
                    activityLog = actData || [];

                    console.log('‚úÖ Datos cargados desde Supabase');
                } catch (error) {
                    console.error('Error cargando desde Supabase:', error);
                    loadFromLocalStorage();
                }
            } else {
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            employees = JSON.parse(localStorage.getItem('employees')) || [
                { id: 1, name: 'Belisario Corrales', password: '333333', blocked: false }
            ];
            records = JSON.parse(localStorage.getItem('timeRecords')) || [];
            activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
        }

        async function saveData() {
            if (useSupabase) {
                try {
                    // Save to Supabase
                    // This is simplified - in production you'd handle inserts/updates properly
                    console.log('üíæ Guardando en Supabase...');
                } catch (error) {
                    console.error('Error guardando en Supabase:', error);
                }
            }
            
            // Always save to localStorage as backup
            localStorage.setItem('employees', JSON.stringify(employees));
            localStorage.setItem('timeRecords', JSON.stringify(records));
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
        }

        // Activity Log
        function logActivity(action, details, user = null) {
            const activity = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                user: user || (currentUser ? currentUser.name : 'Sistema'),
                action: action,
                details: details
            };
            activityLog.unshift(activity);
            saveData();
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        function handleLoginClick() {
            const password = document.getElementById('passwordInput').value.trim();
            const errorEl = document.getElementById('loginError');

            if (!password) {
                errorEl.textContent = '‚ùå Ingrese una contrase√±a';
                errorEl.classList.remove('hidden');
                setTimeout(() => errorEl.classList.add('hidden'), 3000);
                return;
            }

            // Check blocked employees
            const blockedEmployee = employees.find(e => e.password === password && e.blocked);
            if (blockedEmployee) {
                errorEl.textContent = 'üîí Usuario bloqueado. Contacte al administrador.';
                errorEl.classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
                setTimeout(() => errorEl.classList.add('hidden'), 3000);
                logActivity('LOGIN_BLOCKED', `Intento de acceso de usuario bloqueado: ${blockedEmployee.name}`);
                return;
            }

            // Check system users
            if (password === systemPasswords.master) {
                currentUser = { password: systemPasswords.master, role: 'master', name: 'Maestro' };
                logActivity('LOGIN', 'Inicio de sesi√≥n exitoso', 'Maestro');
                showAdminInterface();
                return;
            }

            if (password === systemPasswords.admin) {
                currentUser = { password: systemPasswords.admin, role: 'admin', name: 'Administrador' };
                logActivity('LOGIN', 'Inicio de sesi√≥n exitoso', 'Administrador');
                showAdminInterface();
                return;
            }

            // Check employees
            const employee = employees.find(e => e.password === password && !e.blocked);
            if (employee) {
                currentUser = { ...employee, role: 'employee' };
                logActivity('LOGIN', 'Inicio de sesi√≥n exitoso', employee.name);
                showEmployeeInterface();
                return;
            }

            // Invalid login
            errorEl.textContent = '‚ùå Contrase√±a incorrecta';
            errorEl.classList.remove('hidden');
            document.getElementById('passwordInput').value = '';
            setTimeout(() => errorEl.classList.add('hidden'), 3000);
            logActivity('LOGIN_FAILED', `Intento de acceso fallido`);
        }

        // Show Interfaces
        function showEmployeeInterface() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('employeeInterface').classList.remove('hidden');
            document.getElementById('employeeName').textContent = currentUser.name;
            document.getElementById('passwordInput').value = '';
            updateEmployeeButton();
            resetInactivityTimer();
        }

        function showAdminInterface() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminInterface').classList.remove('hidden');
            document.getElementById('roleIndicator').textContent = currentUser.role.toUpperCase();
            document.getElementById('roleIndicator').className = `role-indicator role-${currentUser.role}`;
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('passwordInput').value = '';
            
            renderEmployeesGrid();
            renderRecordsTable();
            renderDashboard();
            renderActivityLog();
            resetInactivityTimer();
        }

        // ============================================
        // EMPLOYEE ACTIONS
        // ============================================
        function updateEmployeeButton() {
            const today = new Date().toLocaleDateString('es-CO');
            const todayRecords = records.filter(r => r.employeeId === currentUser.id && r.fecha === today);
            
            const entries = todayRecords.filter(r => r.tipo === 'ENTRADA').length;
            const exits = todayRecords.filter(r => r.tipo === 'SALIDA').length;
            
            const btn = document.getElementById('employeeActionBtn');
            const icon = document.getElementById('actionIcon');
            const text = document.getElementById('actionText');
            
            if (entries === exits) {
                btn.className = 'action-btn-large entrada';
                icon.textContent = 'üö™';
                text.textContent = 'ENTRADA';
            } else {
                btn.className = 'action-btn-large salida';
                icon.textContent = 'üëã';
                text.textContent = 'SALIDA';
            }
        }

        async function handleEmployeeAction() {
            const btn = document.getElementById('employeeActionBtn');
            const actionType = btn.classList.contains('entrada') ? 'ENTRADA' : 'SALIDA';
            
            const now = new Date();
            
            const record = {
                id: Date.now(),
                employeeId: currentUser.id,
                employeeName: currentUser.name,
                fecha: now.toLocaleDateString('es-CO'),
                dia: now.toLocaleDateString('es-CO', { weekday: 'long' }),
                tipo: actionType,
                hora: now.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
                dispositivo: navigator.platform,
                timestamp: now.toISOString(),
                observaciones: ''
            };

            records.push(record);
            await saveData();
            
            logActivity(`REGISTRO_${actionType}`, `Registro de ${actionType.toLowerCase()} a las ${record.hora}`, currentUser.name);
            
            showToast(`‚úÖ ${actionType} registrada exitosamente`, 'success');
            showEmployeeRecords();
            
            setTimeout(() => {
                document.getElementById('recordsPreview').classList.add('hidden');
                logout();
            }, 10000);
            
            updateEmployeeButton();
        }

        // ============================================
        // TIME CALCULATIONS (Fixed hh:mm:ss format)
        // ============================================
        function calculateHoursBetween(time1, time2) {
            if (!time1 || !time2) return '00:00:00';
            
            try {
                const t1 = new Date(`2000-01-01 ${time1}`);
                const t2 = new Date(`2000-01-01 ${time2}`);
                
                if (isNaN(t1.getTime()) || isNaN(t2.getTime())) {
                    return '00:00:00';
                }
                
                const diff = Math.abs(t2 - t1);
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } catch (error) {
                console.error('Error calculating hours:', error);
                return '00:00:00';
            }
        }

        // ============================================
        // EMPLOYEE RECORDS DISPLAY
        // ============================================
        function showEmployeeRecords() {
            const preview = document.getElementById('recordsPreview');
            const tbody = document.getElementById('employeeRecordsBody');
            
            const today = new Date().toLocaleDateString('es-CO');
            const yesterday = new Date(Date.now() - 86400000).toLocaleDateString('es-CO');
            
            const recentRecords = records.filter(r => 
                r.employeeId === currentUser.id && 
                (r.fecha === today || r.fecha === yesterday)
            );

            const recordsByDate = {};
            recentRecords.forEach(r => {
                if (!recordsByDate[r.fecha]) recordsByDate[r.fecha] = [];
                recordsByDate[r.fecha].push(r);
            });

            let html = '';
            Object.keys(recordsByDate).sort().reverse().forEach(fecha => {
                const dayRecords = recordsByDate[fecha].sort((a, b) => 
                    new Date(`2000-01-01 ${a.hora}`) - new Date(`2000-01-01 ${b.hora}`)
                );

                for (let i = 0; i < dayRecords.length; i += 2) {
                    const entrada = dayRecords[i]?.tipo === 'ENTRADA' ? dayRecords[i] : null;
                    const salida = dayRecords[i + 1]?.tipo === 'SALIDA' ? dayRecords[i + 1] : null;
                    
                    const hours = (entrada && salida) ? calculateHoursBetween(entrada.hora, salida.hora) : '00:00:00';
                    
                    html += `
                        <tr>
                            <td>${fecha}</td>
                            <td class="mono">${entrada?.hora || '--:--:--'}</td>
                            <td class="mono">${salida?.hora || '--:--:--'}</td>
                            <td class="mono">${hours}</td>
                        </tr>
                    `;
                }
            });

            tbody.innerHTML = html;
            preview.classList.remove('hidden');
        }

        // ============================================
        // ADMIN RECORDS TABLE
        // ============================================
        function renderRecordsTable() {
            const tbody = document.getElementById('recordsTableBody');
            
            const groupedRecords = {};
            records.forEach(r => {
                const key = `${r.employeeId}-${r.fecha}`;
                if (!groupedRecords[key]) groupedRecords[key] = [];
                groupedRecords[key].push(r);
            });

            let html = '';
            Object.keys(groupedRecords).sort().reverse().forEach(key => {
                const dayRecords = groupedRecords[key].sort((a, b) => 
                    new Date(`2000-01-01 ${a.hora}`) - new Date(`2000-01-01 ${b.hora}`)
                );

                for (let i = 0; i < dayRecords.length; i += 2) {
                    const entrada = dayRecords[i]?.tipo === 'ENTRADA' ? dayRecords[i] : null;
                    const salida = dayRecords[i + 1]?.tipo === 'SALIDA' ? dayRecords[i + 1] : null;
                    
                    const hours = (entrada && salida) ? calculateHoursBetween(entrada.hora, salida.hora) : '00:00:00';
                    
                    html += `
                        <tr>
                            <td>${entrada?.fecha || salida?.fecha}</td>
                            <td><strong>${entrada?.employeeName || salida?.employeeName}</strong></td>
                            <td class="mono">${entrada?.hora || '--:--:--'}</td>
                            <td class="mono">${salida?.hora || '--:--:--'}</td>
                            <td class="mono">${hours}</td>
                            <td>${entrada?.observaciones || salida?.observaciones || '-'}</td>
                            <td>
                                ${entrada ? `<button class="btn-small primary" onclick="openEditRecordModal(${entrada.id}, 'entrada')">‚úèÔ∏è</button>` : ''}
                                ${salida ? `<button class="btn-small primary" onclick="openEditRecordModal(${salida.id}, 'salida')">‚úèÔ∏è</button>` : ''}
                                <button class="btn-small primary" onclick="openCommentModal(${entrada?.id || salida?.id})">üí¨</button>
                            </td>
                        </tr>
                    `;
                }
            });

            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No hay registros</td></tr>';
            
            // Apply filters
            filteredRecords = records;
            applyFilters();
        }

        // ============================================
        // FILTERS
        // ============================================
        function applyFilters() {
            const nameFilter = document.getElementById('filterEmployee')?.value.toLowerCase() || '';
            const dateStart = document.getElementById('filterDateStart')?.value || '';
            const dateEnd = document.getElementById('filterDateEnd')?.value || '';

            filteredRecords = records.filter(r => {
                const matchName = !nameFilter || r.employeeName.toLowerCase().includes(nameFilter);
                const recordDate = new Date(r.fecha.split('/').reverse().join('-'));
                const matchStartDate = !dateStart || recordDate >= new Date(dateStart);
                const matchEndDate = !dateEnd || recordDate <= new Date(dateEnd);
                
                return matchName && matchStartDate && matchEndDate;
            });

            renderFilteredRecords();
        }

        function renderFilteredRecords() {
            const tbody = document.getElementById('recordsTableBody');
            
            const groupedRecords = {};
            filteredRecords.forEach(r => {
                const key = `${r.employeeId}-${r.fecha}`;
                if (!groupedRecords[key]) groupedRecords[key] = [];
                groupedRecords[key].push(r);
            });

            let html = '';
            Object.keys(groupedRecords).sort().reverse().forEach(key => {
                const dayRecords = groupedRecords[key].sort((a, b) => 
                    new Date(`2000-01-01 ${a.hora}`) - new Date(`2000-01-01 ${b.hora}`)
                );

                for (let i = 0; i < dayRecords.length; i += 2) {
                    const entrada = dayRecords[i]?.tipo === 'ENTRADA' ? dayRecords[i] : null;
                    const salida = dayRecords[i + 1]?.tipo === 'SALIDA' ? dayRecords[i + 1] : null;
                    
                    const hours = (entrada && salida) ? calculateHoursBetween(entrada.hora, salida.hora) : '00:00:00';
                    
                    html += `
                        <tr>
                            <td>${entrada?.fecha || salida?.fecha}</td>
                            <td><strong>${entrada?.employeeName || salida?.employeeName}</strong></td>
                            <td class="mono">${entrada?.hora || '--:--:--'}</td>
                            <td class="mono">${salida?.hora || '--:--:--'}</td>
                            <td class="mono">${hours}</td>
                            <td>${entrada?.observaciones || salida?.observaciones || '-'}</td>
                            <td>
                                ${entrada ? `<button class="btn-small primary" onclick="openEditRecordModal(${entrada.id}, 'entrada')">‚úèÔ∏è</button>` : ''}
                                ${salida ? `<button class="btn-small primary" onclick="openEditRecordModal(${salida.id}, 'salida')">‚úèÔ∏è</button>` : ''}
                                <button class="btn-small primary" onclick="openCommentModal(${entrada?.id || salida?.id})">üí¨</button>
                            </td>
                        </tr>
                    `;
                }
            });

            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No se encontraron registros</td></tr>';
        }

        function clearFilters() {
            document.getElementById('filterEmployee').value = '';
            document.getElementById('filterDateStart').value = '';
            document.getElementById('filterDateEnd').value = '';
            applyFilters();
        }

        // ============================================
        // RECORD EDITING
        // ============================================
        function openEditRecordModal(recordId, type) {
            if (currentUser.role !== 'master' && currentUser.role !== 'admin') return;
            
            const record = records.find(r => r.id === recordId);
            document.getElementById('editRecordId').value = recordId;
            document.getElementById('editRecordType').value = type;
            document.getElementById('editRecordTime').value = record.hora;
            document.getElementById('editRecordModal').classList.add('active');
        }

        async function handleEditRecord() {
            const recordId = parseInt(document.getElementById('editRecordId').value);
            const newTime = document.getElementById('editRecordTime').value + ':00';
            const reason = document.getElementById('editRecordReason').value.trim();

            if (!reason) {
                showToast('Debe especificar el motivo de la edici√≥n', 'error');
                return;
            }

            const record = records.find(r => r.id === recordId);
            if (record) {
                const oldTime = record.hora;
                record.hora = newTime;
                await saveData();
                
                logActivity('RECORD_EDITED', `Registro editado: ${record.employeeName} - ${record.tipo} - Hora anterior: ${oldTime}, Nueva: ${newTime}. Motivo: ${reason}`, currentUser.name);
                
                renderRecordsTable();
                closeModal('editRecordModal');
                showToast('‚úÖ Registro editado exitosamente', 'success');
                
                document.getElementById('editRecordTime').value = '';
                document.getElementById('editRecordReason').value = '';
            }
        }

        // ============================================
        // OTHER ADMIN FUNCTIONS
        // ============================================
        function renderEmployeesGrid() {
            const grid = document.getElementById('employeesGrid');
            grid.innerHTML = employees.map(emp => `
                <div class="employee-card ${emp.blocked ? 'blocked' : ''}">
                    <div class="employee-name">${emp.name}</div>
                    <div style="color: var(--text-secondary); margin-bottom: 1rem;">
                        ${emp.blocked ? 'üîí Bloqueado' : '‚úÖ Activo'}
                    </div>
                    <div class="employee-actions">
                        <button class="btn-small primary" onclick="openChangePasswordModal(${emp.id})">üîë Contrase√±a</button>
                        <button class="btn-small warning" onclick="toggleBlockEmployee(${emp.id})">
                            ${emp.blocked ? 'üîì Desbloquear' : 'üîí Bloquear'}
                        </button>
                        <button class="btn-small danger" onclick="deleteEmployee(${emp.id})">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function renderDashboard() {
            const today = new Date().toLocaleDateString('es-CO');
            const todayRecords = records.filter(r => r.fecha === today);
            const activeEmployees = new Set(todayRecords.map(r => r.employeeId)).size;
            
            const stats = [
                { icon: 'üë•', label: 'Total Colaboradores', value: employees.filter(e => !e.blocked).length },
                { icon: '‚úÖ', label: 'Activos Hoy', value: activeEmployees },
                { icon: 'üìù', label: 'Registros Hoy', value: todayRecords.length },
                { icon: 'üìä', label: 'Total Registros', value: records.length }
            ];

            document.getElementById('statsGrid').innerHTML = stats.map(stat => `
                <div class="stat-card">
                    <div style="font-size: 2rem; opacity: 0.3;">${stat.icon}</div>
                    <div class="stat-value">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                </div>
            `).join('');
        }

        function renderActivityLog() {
            const tbody = document.getElementById('activityLogBody');
            if (!tbody) return;

            tbody.innerHTML = activityLog.slice(0, 100).map(activity => {
                const date = new Date(activity.timestamp);
                return `
                    <tr>
                        <td class="mono">${date.toLocaleDateString('es-CO')} ${date.toLocaleTimeString('es-CO')}</td>
                        <td><strong>${activity.user}</strong></td>
                        <td>${activity.action}</td>
                        <td style="font-size: 0.9rem;">${activity.details}</td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No hay actividad registrada</td></tr>';
        }

        // ============================================
        // EMPLOYEE MANAGEMENT
        // ============================================
        async function handleAddEmployee() {
            const name = document.getElementById('newEmployeeName').value.trim();
            const password = document.getElementById('newEmployeePassword').value.trim();

            if (!name || !password || password.length !== 6) {
                showToast('Complete todos los campos correctamente', 'error');
                return;
            }

            const newEmployee = {
                id: Date.now(),
                name: name,
                password: password,
                blocked: false
            };

            employees.push(newEmployee);
            await saveData();
            renderEmployeesGrid();
            closeModal('addEmployeeModal');
            showToast('‚úÖ Colaborador agregado', 'success');
            logActivity('EMPLOYEE_ADDED', `Nuevo colaborador: ${name}`, currentUser.name);
            
            document.getElementById('newEmployeeName').value = '';
            document.getElementById('newEmployeePassword').value = '';
        }

        async function handleChangePassword() {
            const userId = parseInt(document.getElementById('changePasswordUserId').value);
            const newPassword = document.getElementById('newPassword').value.trim();

            if (!newPassword || newPassword.length !== 6) {
                showToast('La contrase√±a debe tener 6 d√≠gitos', 'error');
                return;
            }

            const employee = employees.find(e => e.id === userId);
            if (employee) {
                const oldPassword = employee.password;
                employee.password = newPassword;
                await saveData();
                closeModal('changePasswordModal');
                showToast('‚úÖ Contrase√±a cambiada', 'success');
                logActivity('PASSWORD_CHANGED', `Contrase√±a de ${employee.name} cambiada`, currentUser.name);
                document.getElementById('newPassword').value = '';
            }
        }

        async function changeOwnPassword() {
            const newPassword = document.getElementById('newOwnPassword').value.trim();

            if (!newPassword || newPassword.length !== 6) {
                showToast('La contrase√±a debe tener 6 d√≠gitos', 'error');
                return;
            }

            if (currentUser.role === 'master') {
                systemPasswords.master = newPassword;
                localStorage.setItem('masterPassword', newPassword);
                currentUser.password = newPassword;
                showToast('‚úÖ Contrase√±a cambiada', 'success');
                logActivity('PASSWORD_CHANGED', 'Contrase√±a de Maestro cambiada', 'Maestro');
            } else if (currentUser.role === 'admin') {
                systemPasswords.admin = newPassword;
                localStorage.setItem('adminPassword', newPassword);
                currentUser.password = newPassword;
                showToast('‚úÖ Contrase√±a cambiada', 'success');
                logActivity('PASSWORD_CHANGED', 'Contrase√±a de Administrador cambiada', 'Administrador');
            }

            document.getElementById('newOwnPassword').value = '';
        }

        async function handleAddComment() {
            const recordId = parseInt(document.getElementById('commentRecordId').value);
            const comment = document.getElementById('commentText').value.trim();

            const record = records.find(r => r.id === recordId);
            if (record) {
                record.observaciones = comment;
                await saveData();
                renderRecordsTable();
                closeModal('addCommentModal');
                showToast('‚úÖ Comentario guardado', 'success');
                logActivity('COMMENT_ADDED', `Comentario en registro de ${record.employeeName}`, currentUser.name);
                document.getElementById('commentText').value = '';
            }
        }

        async function toggleBlockEmployee(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (employee) {
                employee.blocked = !employee.blocked;
                await saveData();
                renderEmployeesGrid();
                showToast(`‚úÖ ${employee.name} ${employee.blocked ? 'bloqueado' : 'desbloqueado'}`, 'success');
                logActivity(`EMPLOYEE_${employee.blocked ? 'BLOCKED' : 'UNBLOCKED'}`, employee.name, currentUser.name);
            }
        }

        async function deleteEmployee(employeeId) {
            const employee = employees.find(e => e.id === employeeId);
            if (confirm(`¬øEliminar a ${employee.name}?`)) {
                employees = employees.filter(e => e.id !== employeeId);
                await saveData();
                renderEmployeesGrid();
                showToast('‚úÖ Colaborador eliminado', 'success');
                logActivity('EMPLOYEE_DELETED', employee.name, currentUser.name);
            }
        }

        // ============================================
        // EXPORT TO EXCEL
        // ============================================
        function exportToExcel() {
            const data = [];
            const groupedRecords = {};
            
            filteredRecords.forEach(r => {
                const key = `${r.employeeId}-${r.fecha}`;
                if (!groupedRecords[key]) groupedRecords[key] = [];
                groupedRecords[key].push(r);
            });

            Object.keys(groupedRecords).sort().reverse().forEach(key => {
                const dayRecords = groupedRecords[key].sort((a, b) => 
                    new Date(`2000-01-01 ${a.hora}`) - new Date(`2000-01-01 ${b.hora}`)
                );

                for (let i = 0; i < dayRecords.length; i += 2) {
                    const entrada = dayRecords[i]?.tipo === 'ENTRADA' ? dayRecords[i] : null;
                    const salida = dayRecords[i + 1]?.tipo === 'SALIDA' ? dayRecords[i + 1] : null;
                    const hours = (entrada && salida) ? calculateHoursBetween(entrada.hora, salida.hora) : '00:00:00';

                    data.push({
                        'FECHA': entrada?.fecha || salida?.fecha,
                        'COLABORADOR': entrada?.employeeName || salida?.employeeName,
                        'ENTRADA': entrada?.hora || '',
                        'SALIDA': salida?.hora || '',
                        'HORAS (hh:mm:ss)': hours,
                        'OBSERVACIONES': entrada?.observaciones || salida?.observaciones || ''
                    });
                }
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Registros');

            const fileName = `Horarios_${new Date().toLocaleDateString('es-CO').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showToast('üìä Excel exportado', 'success');
            logActivity('EXPORT_EXCEL', fileName, currentUser.name);
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');

            if (tabName === 'activity') renderActivityLog();
        }

        function openAddEmployeeModal() {
            document.getElementById('addEmployeeModal').classList.add('active');
        }

        function openChangePasswordModal(userId) {
            document.getElementById('changePasswordUserId').value = userId;
            document.getElementById('changePasswordModal').classList.add('active');
        }

        function openCommentModal(recordId) {
            const record = records.find(r => r.id === recordId);
            document.getElementById('commentRecordId').value = recordId;
            document.getElementById('commentText').value = record?.observaciones || '';
            document.getElementById('addCommentModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function logout() {
            if (currentUser) {
                logActivity('LOGOUT', 'Cierre de sesi√≥n', currentUser.name);
            }
            currentUser = null;
            if (inactivityTimer) clearTimeout(inactivityTimer);
            document.getElementById('employeeInterface').classList.add('hidden');
            document.getElementById('adminInterface').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('passwordInput').value = '';
            setupPasswordFocus();
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const passInput = document.getElementById('passwordInput');
            if (passInput) {
                passInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLoginClick();
                });
            }
        });

        // Initialize
        init();
    </script>
</body>
</html>
